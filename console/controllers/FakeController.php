<?php

namespace console\controllers;
use common\widgets\Uploader;
use Yii;
use yii\db\Query;
use yii\helpers\Console;

/**
 * Class FakeController
 * @package console\controllers
 * @property Uploader|\common\widgets\Uploader $uploadAli
 */
class FakeController extends \yii\console\Controller
{
    private $uploadAli;
    function init()
    {
        Yii::$app->setComponents(
            [
                'db' => [
                    'class'       => 'yii\db\Connection',
                    'dsn'         => 'mysql:host=gz-cdb-ecmy83dx.sql.tencentcdb.com;port=62387;dbname=bdm314524321_db',
                    'username'    => 'root',
                    'password'    => 'hjzhome888',
                    'charset'     => 'GBK',
                    'tablePrefix' => 'ecs_',
                ],
            ]
        );
        $this->uploadAli = new Uploader();
        parent::init(); // TODO: Change the autogenerated stub
    }

    /**
     * @param $path
     * @param int $isOrigin
     * @return array
     */
    private function upload($path,$isOrigin=0)
    {
        //获取荟家装服务器图片, 判断本地是否存在, 不存在则获取图片保存在临时文件夹, 再用临时地址上传到顽兔, 上传前验证文件目录是否存在
        // file_get_contents() gbk地址请求-no  utf8地址请求-yes
        // file_put_contents() gbk保存地址-yes  utf8保存地址-yes(地址乱码)
        // test_upload_file_c() 文件名编码必须为utf8
        // urldecode() 解决因为url编码图片不能访问的问题
        try{
            $basePath = "http://tx.hjzhome.com/";
            $localRoot = $isOrigin? "/home/image/":"E:\phpStudy\PHPTutorial\WWW\hjz\htdocs/";
            $localPutRoot = $isOrigin? "/home/image/":"E:\phpStudy\PHPTutorial\WWW\hjz\htdocs/images/alishi4/";

            $filename = $basePath.$path;//远程地址
            $localFilename = $localRoot.$path;//本地图片库
            $urldepath = mb_strpos($path, '%')!==false? iconv("utf-8","gbk", urldecode($path)):$path;//urldecode 转码,转码后为utf8,再转为gbk
            $localPutFilename = $localPutRoot.basename($urldepath);//本地临时图片地址
            $space = 'hjzimage'; //顽兔图片空间
            $spacePath = dirname($path); //空间相对路径

            if (!is_file($localFilename)){
                //保存到临时文件夹
                $filename = iconv("gbk","utf-8", $filename);
                $origin = file_get_contents($filename);
                file_put_contents($localPutFilename, $origin);
                $localFilename = iconv("gbk","utf-8", $localPutFilename);
            }
//            p($localFilename,1);
            $wtRes = $this->uploadAli->test_upload_file_c($localFilename, $space, $spacePath);
            return $wtRes;
        }catch (\Exception $e){
            p($e->getMessage());
            p(__METHOD__);
            return [];
        }
    }

    /**
     * 缩略图,封面图, 上传到百川顽兔
     * @param int $start
     * @param int $end
     * @throws \yii\db\Exception
     */
    public function actionGetData($start=0, $end=0){
//        $origin = file_get_contents("http://tx.hjzhome.com/images/btn_fold.gif");
//        file_put_contents("E:\phpStudy\PHPTutorial\WWW\hjz\htdocs/images/alishi4/123.gif", $origin);
//        p($end,1);
        $db = Yii::$app->getDb();
        $data = (new Query())->select("goods_id,tuijie_img,goods_thumb,goods_img")
            ->from("ecs_goods")
//            ->where(['between', 'goods_id', $start, $end])
            ->limit($start)
            ->orderBy("goods_img desc")
            ->all($db);
//        p($data,1);
        foreach ($data as $goodimgs){
            $status = ['goods_id'=>$goodimgs['goods_id'], 'tuijie_img'=>0,'goods_thumb'=>0,'goods_img'=>0];//默认状态,'original_img'=>0
            $good_id = $goodimgs['goods_id'];
            foreach ($goodimgs as $attr => $img){
                $existHjzhome = strpos($img,'hjzhome.com');//未上传到顽兔的图片
                if ($attr!="goods_id" && $img && !$existHjzhome){
//                    p("$attr:{$img}".PHP_EOL.PHP_EOL);
                    $res = $this->upload($img);
                    if (array_key_exists('code',$res) && $res['code']=="OK"){
                        $status[$attr] = 1;
                        //更新数据库字段
                        $fullPath = 'http://image.hjzhome.com/'.$img;
                        $db->createCommand()->update('ecs_goods',[$attr=>$fullPath],['goods_id'=>$good_id])->execute();
                    }
                    p("good_id:{$good_id} -- {$attr}:{$status[$attr]}".PHP_EOL.PHP_EOL);
                }
                usleep(800);
            }
            $db->createCommand()->insert('move_ali_log',$status)->execute();
        }
    }

    /**
     * 富文本上传本地图片到顽兔
     * @param int $start
     * @param int $end
     * @throws \yii\db\Exception
     */
    public function actionDescUpload($start=0, $end=0, $isOrigin=0){
        $db = Yii::$app->getDb();
        $data = (new Query())->from("ecs_goods")
            ->select("goods_id,goods_desc")
            ->where(['between', 'goods_id', $start, $end])
            ->andWhere("is_real=1 or is_delete=0")
            ->all($db);
        //p($data,1);
        foreach ($data as $desc){
            preg_match_all("/<img src=\"(.*)\"/U", $desc['goods_desc'], $matches);//正则匹配图片地址
            p($matches[1]);
            //不符合规则图片地址过滤
            if(empty($matches[1])){
                continue;
            }
            $status = 1;
            foreach ($matches[1] as $key=>$imgUrl){
                $existHjzhome = strpos($imgUrl,'hjzhome.com');//已经上传到顽兔
                $existHjzhome2 = strpos($imgUrl,'hjzhome.image');//已经上传到顽兔
                //过滤不符合规则图片地址
                if($existHjzhome || $existHjzhome2){
                    continue;
                }
                //p($imgUrl.PHP_EOL.PHP_EOL);continue;
                //判断图片格式
                $postfix = trim(strrchr($imgUrl, '.'),'.');
                if (in_array($postfix, ["jpg","png","gif","jpeg"])){
                    $res = $this->upload($imgUrl, $isOrigin);
                    if (!array_key_exists('code',$res) || $res['code']!="OK"){
                        $status = 0;
                        $res['url'] = "";
                        p("上传失败!!! -- {$desc['goods_id']} -- $imgUrl");
                        //记录上传失败的图片地址
                        $db->createCommand()->insert('move_ali_fail_log',["url"=>$imgUrl, "goods_id"=>$desc['goods_id']])->execute();
                    }
                    p("$key -- {$desc['goods_id']} -- {$imgUrl}".PHP_EOL.PHP_EOL);
                    usleep(800);
                }
            }
            $db->createCommand()->insert('move_ali_log',["goods_desc"=>$status,"goods_id"=>$desc['goods_id'] ])->execute();
        }
    }

    /**
     * 富文本替换上传成功的图片地址
     * @param int $start
     * @param int $end
     */
    public function actionReplace($start=0, $end=0){
        $db = Yii::$app->getDb();
        $data = (new Query())->from("ecs_goods")
            ->select("goods_id,goods_desc")
            ->where(['between', 'goods_id', $start, $end])
            ->andWhere("is_real=1 or is_delete=0")
            ->all($db);
        //$newDesc = $this->get_img_thumb_url($data[0]['goods_desc'],"http://image.hjzhome.com/");
        //p("操作阿斯蒂芬",1,1);
        foreach ($data as $key=>$desc){
            preg_match_all("/<img src=\"\/(.*)\"/U", $desc['goods_desc'], $matches);//正则匹配图片地址
            //不符合规则图片地址过滤
            if(empty($matches[1])){
                continue;
            }
            $matches[1]['goods_id'] = $desc['goods_id'];
            p($matches[1]);
            p(PHP_EOL.$desc['goods_desc'].PHP_EOL.PHP_EOL);
            //添加图片前缀
            $newDesc = $this->get_img_thumb_url($desc['goods_desc'],"http://image.hjzhome.com/");
            try{
                p(PHP_EOL.$newDesc.PHP_EOL.PHP_EOL);
                $res = $this->confirm(iconv('utf-8','gbk',"是否继续操作?"),1);
                if (!$res){
                    p("停止操作",0,1);
                    break;
                }
                @$db->createCommand()->update('ecs_goods',["goods_desc"=>$newDesc],["goods_id"=>$desc['goods_id']])->execute();
                p("更新成功!!! {$desc['goods_id']}".PHP_EOL.PHP_EOL,0,1);
                usleep(800);
            }catch (\yii\db\Exception $e){
                p("更新失败!!! {$desc['goods_id']} -- ".$e->getMessage().PHP_EOL.PHP_EOL,0,1);
            }
        }
    }

    /**
     *  图片地址替换成压缩URL
     * @param string $content  内容
     * @param string $prefix  前缀
     * @param string $suffix  后缀
     * @return null|string|string[]
     */
    private function get_img_thumb_url($content="",$prefix="",$suffix="")
    {
/*        $pregRule = "/<[img|IMG].*?src=[\'|\"][\/](.*?(?:[\.jpg|\.jpeg|\.png|\.gif]))[\'|\"].*?[\/]?>/";*/
        $pregRule = "/<img src=\"\/(.*)\"/U";
        $content = preg_replace($pregRule, '<img src="'.$prefix.'${1}'.$suffix.'"', $content);
        return $content;
    }

    /**
     * 商品图册图片上传
     * @param int $start
     * @param int $end
     * @throws \yii\db\Exception
     */
    public function actionGalleryUpload($start=0, $end=0){
        $db = Yii::$app->getDb();
        $data = (new Query())->select("goods_id,img_url,thumb_url")//,img_original
            ->from("ecs_goods_gallery")
            ->limit($start)
            ->orderBy("img_url desc")
//            ->where(['between', 'goods_id', $start, $end])
            ->all($db);
//        p($data,1);
        foreach ($data as $v){
            $status = 1;
            $good_id = $v['goods_id'];
            foreach ($v as $k => $vv){
                $existHjzhome = strpos($vv,'hjzhome.com');//未上传到顽兔的图片
                if ($k=="goods_id" || empty($vv) || $existHjzhome){
                    continue;
                }
                //判断图片格式
                $res = $this->upload($vv);
                if (!array_key_exists('code',$res) || $res['code']!="OK"){
                    $status = 0;
                    $res['url'] = "";
                }else{
                    //更新数据库字段
                    $fullPath = 'http://image.hjzhome.com/'.$vv;
                    $db->createCommand()->update('ecs_goods_gallery',[$k=>$fullPath],['goods_id'=>$good_id])->execute();
                }
                p("{$v['goods_id']} -- {$status} -- {$vv} -- {}".PHP_EOL.PHP_EOL);
                usleep(800);
            }
            $db->createCommand()->update('move_ali_log',["goods_gallery"=>$status],["goods_id"=>$v['goods_id']])->execute();
        }
    }

    /**
     * updated the topic pictures
     *
     * @param int $start
     * @param int $end
     * @param int $isOrigin
     * @throws \yii\db\Exception
     */
    public function actionTopic($start=0, $end=0, $isOrigin=0){
//        $img = iconv("utf-8","gbk","/images/upload/Image/红底新logo.jpg");
//        $res = $this->upload($img);
//        p($res,1);
        $db = Yii::$app->getDb();
        $data = (new Query())->select("goods_desc_images")
            ->from("move_ali_log")
            ->where(['goods_id'=>3])
            ->scalar($db);
        $imageArr = explode(',', $data);
        foreach ($imageArr as $vv){
            //判断图片格式
            $postfix = trim(strrchr($vv, '.'),'.');
            if (in_array($postfix, ["jpg","png","gif","jpeg"])){
                $res = $this->upload($vv);
                if (!array_key_exists('code',$res) || $res['code']!="OK"){
                    $res['url'] = "";
                    p($res);
                    //记录上传失败的图片地址
                    $db->createCommand()->insert('move_ali_fail_log',["url"=>$vv, "goods_id"=>3])->execute();
                }
                p("{$vv} -- {$res['url']}".PHP_EOL.PHP_EOL);
                usleep(1000);
            }
        }
    }

    /**
     * 上传失败记录表
     * @throws \yii\db\Exception
     */
    public function actionFailRecall(){
        $db = Yii::$app->getDb();
        $goodsId = (new Query())->select("goods_id")
            ->from("move_ali_fail_log")
            ->where(["status"=>0,"is_all"=>1])
            ->column();

        $data = (new Query())->select("goods_id,goods_desc_images")
            ->from("move_ali_log")
            ->where(['in', 'goods_id',$goodsId])
            ->all($db);

        foreach ($data as $v){
            if(empty($v['goods_desc_images'])){
                continue;
            }
            $imageArr = explode(',', $v['goods_desc_images']);
            $status = 1;
            foreach ($imageArr as $vv){
                //判断图片格式
                $postfix = trim(strrchr($vv, '.'),'.');
                if (in_array($postfix, ["jpg","png","gif","jpeg"])){
                    $res = $this->upload($vv);
                    if (!array_key_exists('code',$res) || $res['code']!="OK"){
                        $status = 0;
                        $res['url'] = "";
                        p($res);
                        //记录上传失败的图片地址
                        $db->createCommand()->insert('move_ali_fail_log',["url"=>$vv, "goods_id"=>$v['goods_id']])->execute();
                    }
                    p("good_id:{$v['goods_id']} -- {$vv} -- {$res['url']}".PHP_EOL.PHP_EOL);
                    usleep(1000);
                }
            }
            $db->createCommand()->update('move_ali_fail_log',["status"=>$status],["goods_id"=>$v['goods_id']])->execute();
        }
    }

    /**
     * 复制地址上传到顽兔
     * 坑点 1.因为控制台输入url内容编码为GBK,所以得转码为UTF8后再做urlencode
     * @param string $item
     * @param int $type
     * @return bool
     */
    public function actionUrlUpload($item="",$type=1){
        //可获取远程内容地址
        //images/upload/Image/%E5%B0%9A%E9%AB%98%E5%8D%AB%E6%B5%B4%20%E6%B7%8B%E6%B5%B4%E5%B1%8F-2(2).jpg
        //images/upload/Image/%C9%D0%B8%DF%CE%C0%D4%A1%20%C1%DC%D4%A1%C6%C1-2%282%29.jpg
        //images/upload/Image/%E5%B0%9A%E9%AB%98%E5%8D%AB%E6%B5%B4%20%E6%B7%8B%E6%B5%B4%E5%B1%8F-2%282%29.jpg

        if (empty($item)) return false;
        if ($type==1){
            $url = (new Query())->from("move_ali_log")
                ->select("goods_desc_images")
                ->where(['goods_id'=>$item])
                ->scalar();
            $url = strpos($url, 'Git')!==false? ltrim(strstr($url,"t"),'t'):$url;
            $url = strpos($url, ',')!==false? explode(',',$url) : $url;
            foreach ($url as $k=> $v){
                try{
                    $rawUrl = dirname($v).'/'.rawurlencode(iconv("gbk","utf-8", basename($v)));

                    $origin = file_get_contents("http://www.hjzhome.com/".$rawUrl);
                    $localFilename = "E:\phpStudy\PHPTutorial\WWW\hjz\htdocs\images\alishi3/".basename($v);
                    file_put_contents($localFilename, $origin);//p($rawUrl.PHP_EOL.PHP_EOL,1);
                    $localFilename = iconv("gbk","utf-8", $localFilename);
                    $res = $this->uploadAli->test_upload_file_c($localFilename, "hjzimage", dirname($v));
                    p($res);
                }catch (\Exception $e){
                    p($k);
                    p($e->getMessage());
                }
            }
        }elseif ($type==2){
            //处理绝对路径
            $fullRemoteUrl = $item;
            $spacePath = basename(dirname($fullRemoteUrl));
            //$rawUrl = dirname($fullRemoteUrl).'/'.rawurlencode(iconv("gbk","utf-8", basename($fullRemoteUrl)));
            $origin = file_get_contents($fullRemoteUrl);
            $localFilename = "E:\phpStudy\PHPTutorial\WWW\hjz\htdocs\images\alishi5/".basename($fullRemoteUrl);
            file_put_contents($localFilename, $origin);
//            $localFilename = iconv("gbk","utf-8", $localFilename);
            $res = $this->uploadAli->test_upload_file_c($localFilename, "hjzhome", 'hjzWebsite/'.$spacePath);
            if ($res['code']=="OK"){
                p($res['url']);
                return $res['url'];
            }else{
                p($res,1);
            }
        }elseif ($type==3){
            // 处理相对路径的图片
            $rootPath = "https://show.metinfo.cn/muban/M1156010/328/case/";
            $basePath = $item;
            $spacePath = basename(dirname($basePath));
            $fullRemoteUrl = $rootPath.$basePath;
//            $rawUrl = dirname($fullRemoteUrl).'/'.rawurlencode(iconv("gbk","utf-8", basename($fullRemoteUrl)));
            $origin = file_get_contents($fullRemoteUrl);
            $localFilename = "E:\phpStudy\PHPTutorial\WWW\hjz\htdocs\images\alishi5/".basename($fullRemoteUrl);
            file_put_contents($localFilename, $origin);
//            $localFilename = iconv("gbk","utf-8", $localFilename);
            $res = $this->uploadAli->test_upload_file_c($localFilename, "hjzhome", 'hjzWebsite/'.$spacePath);
            if ($res['code']=="OK"){
//                p($res['url']);
                return $res['url'];
            }else{
                p($res,1);
            }
        }elseif ($type==4){
            //测试
            $str = "upload/thumb_src/125_100/1500452786.jpg,upload/thumb_src/125_100/1500449642.jpg,upload/thumb_src/125_100/1500451911.jpg,upload/thumb_src/125_100/1500456343.jpg";
            $arr = explode(',', $str);
            // 处理相对路径的图片
            foreach ($arr as $k=>$v){
                $rootPath = "https://show.metinfo.cn/muban/M1156010/328/";
                $basePath = $v;
                $fullRemoteUrl = $rootPath.$basePath;
                $origin = file_get_contents($fullRemoteUrl);
                $localFilename = "E:\phpStudy\PHPTutorial\WWW\hjz\htdocs\images\alishi5/".basename($fullRemoteUrl);
                file_put_contents($localFilename, $origin);
                //p($rawUrl,1);
                $localFilename = iconv("gbk","utf-8", $localFilename);
                $res = $this->uploadAli->test_upload_file_c($localFilename, "hjzhome", 'hjzWebsite');
                if ($res['code']=="OK"){
                    p($res['url'].PHP_EOL.PHP_EOL);
//                    return $res['url'];
                }else{
                    p($res,1);
                }
                usleep(800);
            }
        }
    }

    /**
     * 获取页面内容并替换其中图片内容
     * @param string $pagePath 页面绝对路径
     * @throws \yii\db\Exception
     */
    public function actionWebPageLink($pagePath=''){

        $wtRes=$this->upload("/images/upload/Image/%E5%85%A8%E6%99%AF%E6%95%88%E6%9E%9C%E8%AF%A6%E7%BB%86%E9%A1%B5_03.jpg");
        p($wtRes,1);
        $res = Yii::$app->db->createCommand("select url from move_ali_fail_log where goods_id=9999")->queryScalar();
        $file = "http://www.hjzhome.com/".$res;
        $putFile = "E:\phpStudy\PHPTutorial\WWW\hjz\htdocs/images/alishi/".basename($res);
        $utf8 = iconv("gbk", "utf-8", $file);
        $origin = file_get_contents($utf8);
        file_put_contents($putFile, $origin);
        try{
            $putFile = iconv("GB2312", "UTF-8", $putFile);
            $wtRes = $this->uploadAli->test_upload_file_c($putFile, "hjzimage", dirname($res));
        }catch (\Exception $e){
//            p($e->getMessage());
        }
        p($wtRes);
    }

    /**
     * @param int $file
     */
    public function actionReplaceFile($file=""){
        $path = "E:/phpStudy/PHPTutorial/WWW/shiling/frontend/views/demo/";
        $fileName = "{$file}.php";
        $fullName = $path.$fileName;
        $content = file_get_contents($fullName);
//        $pregRule = "/(data-background|data-src)=(\"|')(.*)(\"|')/U";
        $pregRule = "/(data-background|data-original|data-src)=(\"|')(.*)(\"|')/U";

        //查看需要替换的地址
        preg_match_all($pregRule,$content,$matches);
        p($matches);
        $this->confirm("go on?",1);
        $pregContent = $content;
        foreach ($matches[3] as $k=>$v){
            try{
                if (strpos($v,'ttp') != false){
                    $url = $this->runAction('url-upload',[$v,2]);
                }else{
                    $url = $this->runAction('url-upload',[$v,3]);
                }
                P($url.PHP_EOL.PHP_EOL);
//                    $this->confirm("{$url} --- go on?",1);
            }catch (\Exception $e){
                p($e->getMessage(),1,1);
            }
            $v = str_replace('/','\/',$v); // '/' 转义,地址转义
            $pregRule = "/({$v})/U"; //替换规则
            $replcement = $url; //替换内容
            $pregContent = preg_replace($pregRule, $replcement, $pregContent);
            usleep(800);
        }
        p($pregContent);
        file_put_contents($fullName, $pregContent);
    }
}
