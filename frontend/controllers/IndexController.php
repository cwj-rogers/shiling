<?php

namespace frontend\controllers;
use Yii;
use yii\web\Controller;
use common\models\WxGoods;
use common\models\WxUser;
use common\models\WxActivitiesOrder;
use common\models\WxFriendsJoinLog;

class IndexController extends Controller
{
    /**
     * @var string
     */
//    public $layout = 'main';
    public $layout = 'kjmain';

    /**
     * @var
*/
    public function init()
    {
        //平台验证和授权验证
        if (Yii::$app->wechat->isWechat && !Yii::$app->wechat->isAuthorized()){
            Yii::$app->wechat->authorizeRequired()->send();
        }
        if(!Yii::$app->session->has("userinfo") && Yii::$app->wechat->isAuthorized()){
            (new WxUser)->createUser();
        }
        parent::init(); // TODO: Change the autogenerated stub
    }

    public function actionIndex(){
        //验证服务器
        if (Yii::$app->request->get('echostr',false)){
            //执行服务端业务
            $response = Yii::$app->wechat->server->serve();
            // 将响应输出
            $response->send();
        }
        $res = [];//储存数据集
        $res['goodslist'] = WxGoods::goodsList();
//        p($res['goodslist']);
        //砍价活动页
        return $this->render('kanjia', ['res'=>$res]);
    }

    /**
     * @return 砍价详情
     */
    public function actionDetail(){
        /**
         * 1. 判断是自己还是好友访问
         * 2. 自己: 第一次进入? 创建新商品订单(砍一刀):读取数据库  已分享? 先砍一刀:不操作  砍价成功? 微信通知:到期提醒
         * 3. 好友: 符合砍价条件? 进入砍价: 不符合; 第一次砍价? 创建新用户: 直接砍价;
         */
        $userId = Yii::$app->request->get('user_id',0);
        $wgId = Yii::$app->request->get('wg_id',0);
        if(!$userId || !$wgId){
            $this->redirect(['index']);
        }
        if($_SESSION['userinfo']['user_id']==$userId){
            //自己的访问
            $isexist = WxActivitiesOrder::findOne(['user_id'=>$userId,'wg_id'=>$wgId]);
            //首次进入创建订单
            if (empty($isexist)){
                (new WxActivitiesOrder)->createActOrder($wgId, $userId);
            }

        }else{
            //朋友访问
        }
        $res = WxActivitiesOrder::getActOrder($wgId, $userId);
        return $this->render('kj-detail', ['res'=>$res]);
    }

//    public function actionJoinerInfo($agoId)
//    {
//        if (Yii::$app->request->isAjax && $agoId){
//            $res = WxFriendsJoinLog::findAll(['ago_id'=>$agoId]);
//            $res = array_map(function($v){return $v->attributes;},$res);
//            \common\helpers\FuncHelper::ajaxReturn(0,'success',$res);
//        }
//    }

    /**
     * @return 用户中心
     */
    public function actionUser(){
        if (Yii::$app->request->isPjax){

        }else{

        }
        return $this->render('user');
    }

    public function actionClear(){
        Yii::$app->session->removeAll();
        p(Yii::$app->session);
    }
}
