<?php

namespace frontend\controllers;
use Yii;
use yii\web\Controller;
use common\models\WxGoods;
use common\models\WxUser;
use common\models\WxActivitiesOrder;
use common\models\WxFriendsJoinLog;

class IndexController extends Controller
{
    /**
     * @var string
     */
//    public $layout = 'main';
    public $layout = 'kjmain';

    /**
     * 初始化 微信授权 保存微信用户信息
     */
    public function init()
    {
        //平台验证和授权验证
        if (Yii::$app->wechat->isWechat && !Yii::$app->wechat->isAuthorized()){
            Yii::$app->wechat->authorizeRequired()->send();
        }
        if(!Yii::$app->session->has("userinfo") && Yii::$app->wechat->isAuthorized()){
            (new WxUser)->createUser();
        }
        parent::init(); // TODO: Change the autogenerated stub
    }

    public function actionIndex(){
        //验证服务器
        if (Yii::$app->request->get('echostr',false)){
            //执行服务端业务
            $response = Yii::$app->wechat->server->serve();
            // 将响应输出
            $response->send();
        }
        $res = [];//储存数据集
        $res['goodslist'] = WxGoods::goodsList();
        //砍价活动页
        return $this->render('kanjia', ['res'=>$res]);
    }

    /**
     * @return 砍价详情
     */
    public function actionDetail(){
        /**
         * 1. 判断是自己还是好友访问
         * 2. 自己: 第一次进入? 创建新商品订单(砍一刀):读取数据库  已分享? 先砍一刀:不操作  砍价成功? 微信通知:到期提醒
         * 3. 好友: 符合砍价条件? 进入砍价: 不符合; 第一次砍价? 创建新用户: 直接砍价;
         */
        $userId = Yii::$app->request->get('user_id',0);
        $wgId = Yii::$app->request->get('wg_id',0);
        if(!$userId || !$wgId || !isset($_SESSION['userinfo'])){
            return $this->redirect(['index']);
        }
        if($_SESSION['userinfo']['user_id']==$userId){
            //自己的访问
            $isexist = WxActivitiesOrder::findOne(['user_id'=>$userId,'wg_id'=>$wgId]);
            //首次进入创建订单
            if (empty($isexist)){
                (new WxActivitiesOrder)->createActOrder($wgId, $userId);
            }

        }else{
            //朋友访问

        }
        $res = WxActivitiesOrder::getActOrder($wgId, $userId);
        return $this->render('kj-detail', ['res'=>$res]);
    }

    /**
     * 异步访问砍价功能
     * @param $agoId
     * @param $userId
     * @param int $lat
     * @param int $lon
     * @throws \yii\db\Exception
     */
    public function actionKj($agoId,$userId,$lat=0,$lon=0)
    {
        if (Yii::$app->request->isAjax && $agoId && $userId){
            //找出商品订单
            $order = WxActivitiesOrder::findOne(['ago_id'=>$agoId,'user_id'=>$userId, 'ago_status'=>1]);
            $order = $order->toArray();
            $SUID = $_SESSION['userinfo']['user_id'];

            if ($order['ago_cut_number']<$order['ago_need_cut'] && strtotime($order['ago_exprice_time'])<time()){
                if($SUID==$userId){
                    //首次进入砍一次, 首次分享砍一次, 分享后本人已经用完砍价机会, 前后台都加判断避免刷单
                    if(0==$order['ago_share_time']){
                        $res = (new WxFriendsJoinLog)->kanjiaRule($order,$agoId,$userId,$lat,$lon);
                        if($res) \common\helpers\FuncHelper::ajaxReturn(200,'success');
                    }
                }else{
                    //朋友砍价条件: 1.同城 2.每天只能一次
                    if($_SESSION['userinfo']['city']==$order['ago_city']){
                        $exsit = WxFriendsJoinLog::findOne(['ago_id'=>$agoId,'user_id'=>$SUID, 'fj_join_date'=>date("Y-m-d")]); //参与条件
                        if (!empty($exsit)){
                            $res = (new WxFriendsJoinLog)->kanjiaRule($order,$agoId,$SUID,$lat,$lon);
                            if($res) \common\helpers\FuncHelper::ajaxReturn(200,'success');
                        }else{
                            \common\helpers\FuncHelper::ajaxReturn(202,'今天砍价机会已用完');
                        }
                    }else{
                        \common\helpers\FuncHelper::ajaxReturn(202,'双方好友必须在同一城市才能砍价');// 返回失败
                    }
                }
            }
        }
        // 返回失败
        \common\helpers\FuncHelper::ajaxReturn(201,'系统无反应');
    }

    /**
     * 异步记录用户地理位置
     */
    public function actionUserLocal()
    {
//        p(is_file("./static/kanjia.mp3"));
        $result = Yii::$app->wechat->app->material->uploadVoice("./static/kanjia.mp3");
        p($result);
//        [media_id] => HmvztPXKVwUEkka4a5wltT4s4hraAxHP5QUO_Cuu0rU
    }

    /**
     * @return 用户中心
     */
    public function actionUser(){
        if (Yii::$app->request->isPjax){

        }else{

        }
        return $this->render('user');
    }

    public function actionClear(){
        Yii::$app->session->removeAll();
        p(Yii::$app->session);
    }
}
